source('src/lter/arctic/domain_helpers.R', local=TRUE)

#retrieval kernels ####

#discharge: STATUS=READY
#. handle_errors
process_0_10502 <- retrieve_arctic

#discharge: STATUS=READY
#. handle_errors
process_0_10503 <- retrieve_arctic

#discharge: STATUS=READY
#. handle_errors
process_0_10504 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10505 <- retrieve_arctic

#discharge: STATUS=READY
#. handle_errors
process_0_1330 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1331 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1334 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1337 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1340 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1344 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1348 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1352 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1356 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1360 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1363 <- retrieve_arctic

#discharge: STATUS=READY
#. handle_errors
process_0_1367 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1370 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1316 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1320 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1324 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10512 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10513 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10514 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10515 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10516 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10517 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10518 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10519 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10520 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10521 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10521 <- retrieve_arctic

#discharge: STATUS=READY
#. handle_errors
process_0_1333 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1336 <- retrieve_arctic

#discharge: STATUS=READY
#. handle_errors
process_0_1339 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1342 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1346 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1350 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1354 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1358 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1362 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1365 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1368 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1372 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1318 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1322 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1326 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1328 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10040 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10043 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10045 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10047 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10049 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10395 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10396 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10510 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10511 <- retrieve_arctic

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_10303 <- retrieve_arctic

#precipitation: STATUS=READY
#. handle_errors
process_0_1489 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_20120 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1593 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1594 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1595 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1596 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1597 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1598 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1599 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1600 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1601 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1589 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1590 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1591 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1592 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1645 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1644 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_1646 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10069 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10068 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10070 <- retrieve_arctic

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_10591 <- retrieve_arctic

#munge kernels ####

#discharge: STATUS=READY
#. handle_errors
process_1_10502 <- munge_discharge

#discharge: STATUS=READY
#. handle_errors
process_1_10503 <- munge_discharge

#discharge: STATUS=READY
#. handle_errors
process_1_10504 <- munge_discharge

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10505 <- munge_discharge_temp

#discharge: STATUS=READY
#. handle_errors
process_1_1330 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1331 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1334 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1337 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1340 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1344 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1348 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1352 <- munge_discharge_temp


#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1356 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1360 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1363 <- munge_discharge_temp

#discharge: STATUS=READY
#. handle_errors
process_1_1367 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1370 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1316 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1320 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1324 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10512 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10513 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10514 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10515 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10516 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10517 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10518 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10519 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10520 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10521 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10521 <- munge_discharge_temp

#discharge: STATUS=READY
#. handle_errors
process_1_1333 <- function(network, domain, prodname_ms, site_code,
                           component){

    rawfile <- glue('data/{n}/{d}/raw/{p}/{s}/{c}.csv',
                    n = network,
                    d = domain,
                    p = prodname_ms,
                    s = site_code,
                    c = component)

    d <- ms_read_raw_csv(filepath = rawfile,
                         datetime_cols = list('Date' = '%d-%b-%y'),
                         datetime_tz = 'America/Anchorage',
                         site_code_col = 'Site',
                         alt_site_code = list('Oksrukuyik_Creek' = '5'),
                         data_cols =  c('Discharge2' = 'discharge'),
                         data_col_pattern = '#V#',
                         set_to_NA = c('-1111', '-1.111'),
                         is_sensor = TRUE)

    d <- ms_cast_and_reflag(d,
                            varflag_col_pattern = NA,
                            variable_flags_to_drop = NA,
                            variable_flags_clean = NA)

    # Convert from cm/s to liters/s
    d <- d %>%
        mutate(val = val*1000)

    d <- qc_hdetlim_and_uncert(d, prodname_ms = prodname_ms)

    d <- synchronize_timestep(d,
                              desired_interval = '1 day', #set to '15 min' when we have server
                              impute_limit = 30)

    return(d)
}

#discharge: STATUS=READY
#. handle_errors
process_1_1336 <-  munge_discharge

#discharge: STATUS=READY
#. handle_errors
process_1_1339 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1342 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1346 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1350 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1354 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1358 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1362 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1365 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1368 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1372 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1318 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1322 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1326 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1328 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10040 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10043 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10045 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10047 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10049 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10395 <- function(network, domain, prodname_ms, site_code,
                            component){

    rawfile <- glue('data/{n}/{d}/raw/{p}/{s}/{c}.csv',
                    n = network,
                    d = domain,
                    p = prodname_ms,
                    s = site_code,
                    c = component)

    alt_site_codes <- detrmin_arctic_site(component)

    if(grepl('discharge', prodname_ms)){

        d <- read.csv(rawfile, colClasses = 'character')

        d[d == '-1111'] <- NA

        d <- d %>%
            rename(cr_q = `CR10X.Calc..Q..m3.sec.`,
                   hobo_q = `HOBO.Calc..Q..m3.sec.`) %>%
            mutate(cr_q = as.numeric(cr_q),
                   hobo_q = as.numeric(hobo_q)) %>%
            mutate(temp = (cr_q+hobo_q)/2) %>%
            mutate(discharge = case_when(is.na(cr_q) & !is.na(hobo_q) ~ hobo_q,
                                         ! is.na(cr_q) & is.na(hobo_q) ~ cr_q,
                                         is.na(cr_q) & is.na(hobo_q) ~ -1111,
                                         !is.na(cr_q) & !is.na(hobo_q) ~ temp)) %>%
            mutate_all(as.character)

        d <- ms_read_raw_csv(preprocessed_tibble = d,
                             datetime_cols = list('Date' = '%d-%b-%y',
                                                  'Time' = '%H:%M'),
                             datetime_tz = 'America/Anchorage',
                             site_code_col = 'River',
                             alt_site_code = alt_site_codes,
                             data_cols =  'discharge',
                             data_col_pattern = '#V#',
                             set_to_NA = c('-1111', '-1.111'),
                             is_sensor = TRUE)

        d <- ms_cast_and_reflag(d,
                                varflag_col_pattern = NA,
                                variable_flags_to_drop = NA,
                                variable_flags_clean = NA)

        # Convert from cm/s to liters/s
        d <- d %>%
            mutate(val = val*1000)

    } else{

        d <- read.csv(rawfile, colClasses = 'character')

        d[d == '-1111'] <- NA

        d <- d %>%
            rename(cr_temp = `CR10X.Temperature...C.`,
                   hobo_temp = `HOBO.Temperature...C.`) %>%
            mutate(cr_temp = as.numeric(cr_temp),
                   hobo_temp = as.numeric(hobo_temp)) %>%
            mutate(temp = (cr_temp+hobo_temp)/2) %>%
            mutate(temperature = case_when(is.na(cr_temp) & !is.na(hobo_temp) ~ hobo_temp,
                                           ! is.na(cr_temp) & is.na(hobo_temp) ~ cr_temp,
                                           is.na(cr_temp) & is.na(hobo_temp) ~ -1111,
                                           !is.na(cr_temp) & !is.na(hobo_temp) ~ temp)) %>%
            select(-temp) %>%
            mutate_all(as.character)

        d <- ms_read_raw_csv(preprocessed_tibble = d,
                             datetime_cols = list('Date' = '%d-%b-%y',
                                                  'Time' = '%H:%M'),
                             datetime_tz = 'America/Anchorage',
                             site_code_col = 'River',
                             alt_site_code = alt_site_codes,
                             data_cols = c('temperature' = 'temp'),
                             set_to_NA = c('-1111', '-1.111'),
                             data_col_pattern = '#V#',
                             is_sensor = TRUE)

        d <- ms_cast_and_reflag(d,
                                varflag_col_pattern = NA,
                                variable_flags_to_drop = NA,
                                variable_flags_clean = NA)
    }

    d <- qc_hdetlim_and_uncert(d, prodname_ms = prodname_ms)

    d <- synchronize_timestep(d,
                              desired_interval = '1 day', #set to '15 min' when we have server
                              impute_limit = 30)

    return(d)
}

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10396 <- function(network, domain, prodname_ms, site_code,
                            component){

    rawfile <- glue('data/{n}/{d}/raw/{p}/{s}/{c}.csv',
                    n = network,
                    d = domain,
                    p = prodname_ms,
                    s = site_code,
                    c = component)

    alt_site_codes <- detrmin_arctic_site(component)

    if(grepl('discharge', prodname_ms)){

        d <- read.csv(rawfile, colClasses = 'character')

        d[d == '-1111'] <- NA

        d <- d %>%
            rename(cr_q = `CR10X.Calc..Q..m3.sec.`,
                   hobo_q = `HOBOCalc..Q..m3.sec.`) %>%
            mutate(cr_q = as.numeric(cr_q),
                   hobo_q = as.numeric(hobo_q)) %>%
            mutate(temp = (cr_q+hobo_q)/2) %>%
            mutate(discharge = case_when(is.na(cr_q) & !is.na(hobo_q) ~ hobo_q,
                                         ! is.na(cr_q) & is.na(hobo_q) ~ cr_q,
                                         is.na(cr_q) & is.na(hobo_q) ~ -1111,
                                         !is.na(cr_q) & !is.na(hobo_q) ~ temp)) %>%
            mutate_all(as.character)

        d <- ms_read_raw_csv(preprocessed_tibble = d,
                             datetime_cols = list('Date' = '%d-%b-%y',
                                                  'Time' = '%H:%M'),
                             datetime_tz = 'America/Anchorage',
                             site_code_col = 'River',
                             alt_site_code = alt_site_codes,
                             data_cols =  'discharge',
                             data_col_pattern = '#V#',
                             set_to_NA = c('-1111', '-1.111'),
                             is_sensor = TRUE)

        d <- ms_cast_and_reflag(d,
                                varflag_col_pattern = NA,
                                variable_flags_to_drop = NA,
                                variable_flags_clean = NA)

        # Convert from cm/s to liters/s
        d <- d %>%
            mutate(val = val*1000)

    } else{

        d <- ms_read_raw_csv(filepath = rawfile,
                             datetime_cols = list('Date' = '%d-%b-%y',
                                                  'Time' = '%H:%M'),
                             datetime_tz = 'America/Anchorage',
                             site_code_col = 'River',
                             alt_site_code = alt_site_codes,
                             data_cols = c('HOBO.Temperature...C.' = 'temp'),
                             set_to_NA = c('-1111', '-1.111'),
                             data_col_pattern = '#V#',
                             is_sensor = TRUE)

        d <- ms_cast_and_reflag(d,
                                varflag_col_pattern = NA,
                                variable_flags_to_drop = NA,
                                variable_flags_clean = NA)
    }

    d <- qc_hdetlim_and_uncert(d, prodname_ms = prodname_ms)

    d <- synchronize_timestep(d,
                              desired_interval = '1 day', #set to '15 min' when we have server
                              impute_limit = 30)

    return(d)
}

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10510 <- munge_discharge_temp

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10511 <- munge_discharge_temp

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_10303 <- function(network, domain, prodname_ms, site_code,
                            component){

    rawfile <- glue('data/{n}/{d}/raw/{p}/{s}/{c}.csv',
                    n = network,
                    d = domain,
                    p = prodname_ms,
                    s = site_code,
                    c = component)

    d <- read.csv(rawfile, colClasses = 'character')

    d <- d[4:nrow(d),]

    check <- d %>%
        group_by(River, Station) %>%
        summarise(count = n())

    sites_lots <- check %>%
        ungroup() %>%
        filter(count >= 300) %>%
        mutate(River = str_replace_all(River, ' ', '_')) %>%
        mutate(site_code = paste(River, Station, sep = '_')) %>%
        select(site_code)

    d <- d %>%
        mutate(site_code = paste(River, Station, sep = '_')) %>%
        mutate(site_code = str_replace_all(site_code, ' ', '_')) %>%
        mutate(site_code = case_when(site_code == 'Oksrukuyik_Creek_Wolf_Creek' ~ 'Wolf_Creek',
                                     site_code == 'Kuparuk_River_Hershey_Creek' ~ 'Hershey_Creek',
                                     TRUE ~ site_code)) %>%
        select(-River) %>%
        right_join(., sites_lots, by = 'site_code')

    na_vec <- vector('character', 64)

    na_vec <- replace(na_vec, values = NA)

    #Sestonic Chlorophyll a same as regular Chlorophyll A?
    #Sestonic Particulate Carbon same as total particulate carbon?
    #Sestonic Particulate Nitrogen same as total particulate nitrogen?
    #Sestonic Particulate Phosphorus same as total particulate P?
    #Ommited Loss on Ignition but can always add back in

    arctic_var_names <- c("Alkalinity", "Ammonium", "Carbon Dioxide", "Cations: Calcium",
                          "Cations: Magnesium","Cations: Potassium",
                          "Cations: Sodium", "Chloride", "Dissolved Inorganic Carbon", "Dissolved Organic Carbon",
                          "Nitrate+Nitrite", "Sestonic Chlorophyll a", "Sestonic Particulate Carbon",
                          "Sestonic Particulate Nitrogen", "Sestonic Particulate Phosphorus",
                          "Sestonic Phaeopigment", "Silica", "Soluble Reactive Phosphorus", "Sulfate",
                          "Total Dissolved Nitrogen",  "Total Dissolved Phosphorus", "Cations: Aluminum",
                          "Cations: Boron", "Cations: Cadmium", "Cations: Chromium", "Cations: Copper", "Cations: Iron",
                          "Cations: Lead", "Cations: Manganese","Cations: Nickel", "Cations: Silicon",
                          "Cations: Strontium", "Cations: Sulfur", "Cations: Zinc", "Conductivity",
                          "Loss on Ignition", "pH", "Sestonic Phaeophytin", "Sestonic Total Chlorophyll",
                          "Specific Conductivity", "Temp when sample collected", "Total Suspended Sediment",
                          "Benthic Ash Free Dry Mass", "Benthic Particulate Carbon", "Benthic Particulate Nitrogen",
                          "Benthic Particulate Phosphorus", "Epilithic Chlorophyll a", "Epilithic Phaeophytin",
                          "Epilithic Total Chlorophyll", "Moss: Hygrohypnum: Aluminum", "Moss: Hygrohypnum: Boron",
                          "Moss: Hygrohypnum: Calcium", "Moss: Hygrohypnum: Carbon", "Moss: Hygrohypnum: Copper",
                          "Moss: Hygrohypnum: Iron", "Moss: Hygrohypnum: Magnesium", "Moss: Hygrohypnum: Manganese",
                          "Moss: Hygrohypnum: Nitrogen", "Moss: Hygrohypnum: Phosphorus", "Moss: Hygrohypnum: Potassium",
                          "Moss: Hygrohypnum: Sodium", "Moss: Hygrohypnum: Sulfur", "Moss: Hygrohypnum: Znnc",
                          "Moss: Schistidium: Aluminum", "Moss: Schistidium: Boron", "Moss: Schistidium: Calcium",
                          "Moss: Schistidium: Carbon", "Moss: Schistidium: Copper", "Moss: Schistidium: Iron",
                          "Moss: Schistidium: LOI", "Moss: Schistidium: Magnesium", "Moss: Schistidium: Manganese",
                          "Moss: Schistidium: Nitrogen", "Moss: Schistidium: Phosphorus","Moss: Schistidium: Potassium",
                          "Moss: Schistidium: Sodium", "Moss: Schistidium: Sulfur", "Moss: Schistidium: Zinc",
                          "Moss: Hygrohypnum: LOI", "Moss: Fontinalis: LOI", "Moss: Fontinalis: Nitrogen",
                          "Moss: Fontinalis: Phosphorus", "Moss: Lemanea: Aluminum", "Moss: Lemanea: Boron",
                          "Moss: Lemanea: Calcium", "Moss: Lemanea: Carbon", "Moss: Lemanea: Copper",
                          "Moss: Lemanea: Iron", "Moss: Lemanea: LOI", "Moss: Lemanea: Magnesium",
                          "Moss: Lemanea: Manganese", "Moss: Lemanea: Nitrogen", "Moss: Lemanea: Phosphorus",
                          "Moss: Lemanea: Potassium", "Moss: Lemanea: Sodium", "Moss: Lemanea: Sulfur" ,
                          "Moss: Lemanea: Zinc", "Moss: Liverwort: Aluminum", "Moss: Liverwort: Boron",
                          "Moss: Liverwort: Calcium", "Moss: Liverwort: Carbon", "Moss: Liverwort: Copper",
                          "Moss: Liverwort: Iron", "Moss: Liverwort: LOI", "Moss: Liverwort: Magnesium",
                          "Moss: Liverwort: Manganese", "Moss: Liverwort: Nitrogen", "Moss: Liverwort: Phosphorus",
                          "Moss: Liverwort: Potassium", "Moss: Liverwort: Sodium", "Moss: Liverwort: Sulfur",
                          "Moss: Liverwort: Zinc", "Moss: Fontinalis: Carbon", "Epilithic Phaeopigment", "Methane")

    var_names <- tibble(Type = arctic_var_names,
                        var = c('alk', 'NH4', 'CO2', 'Ca', 'Mg', 'K', 'Na', 'Cl',
                                'DIC', 'DOC', 'NO3_NO2', 'CHL', 'TPC', 'TPN', 'TPP',
                                'phaeopig', 'SiO2', 'SRP', 'SO4', 'TDN', 'TDP', 'Al',
                                'B', 'Cd', 'Cr', 'Cu', 'Fe', 'Pb', 'Mn', 'Ni', 'Si',
                                'Sr', 'S', 'Zn', 'spCond', NA, 'pH', 'pheophy', 'TCHL',
                                'spCond', 'temp', 'TSS', NA, 'BPC', 'BPN', 'BPP',
                                'ECHL_A', 'E_pheophy', 'T_ECHL', 'MH_Al', 'MH_B', 'MH_Ca',
                                'MH_C', 'MH_Cu',  'MH_Fe', 'MH_Mg', 'MH_Mn', 'MH_N',
                                'MH_P', 'MH_K', 'MH_Na', 'MH_S', 'MH_Zn', 'MS_Al',
                                'MS_B', 'MS_Ca', 'MS_C', 'MS_Cu', 'MS_Fe', NA,
                                'MS_Mg', 'MS_Mn', 'MS_N', 'MS_P', 'MS_K', 'MS_Na',
                                'MS_S', 'MS_Zn', NA, NA, 'MF_N', 'MF_P',
                                'ML_Al', 'ML_B', 'ML_Ca', 'ML_C', 'ML_Cu', 'ML_Fe',
                                NA, 'ML_Mg', 'ML_Mn', 'ML_N', 'ML_P', 'ML_K',
                                'ML_Na', 'ML_S', 'ML_Zn', 'MLW_Al', 'MLW_B', 'MLW_Ca',
                                'MLW_C', 'MLW_Cu', 'MLW_Fe', NA, 'MLW_Mg', 'MLW_Mn',
                                'MLW_N', 'MLW_P', 'MLW_K', 'MLW_Na', 'MLW_S', 'MLW_Zn',
                                'MF_C', NA, 'CH4'))

    d[d == '-9999'] <- NA

    d <- d %>%
        full_join(var_names, by = 'Type') %>%
        select(site_code, datetime=Date, val=Value, Comments, var) %>%
        mutate(ms_status = case_when(Comments == 'ISCO' ~ 0,
                                     Comments == ' ' ~ 0,
                                     TRUE ~ 1)) %>%
        select(-Comments) %>%
        mutate(date = str_split_fixed(datetime, ' ', n = Inf)[,1],
               time = str_split_fixed(datetime, ' ', n = Inf)[,2]) %>%
        mutate(time = ifelse(time == '00:00', '12:00', time)) %>%
        mutate(datetime = as_datetime(paste(date, time, sep = ' '), format = '%Y-%m-%d %H:%M', tz = 'America/Anchorage')) %>%
        mutate(val = as.numeric(val)) %>%
        filter(!is.na(val),
               !is.na(var)) %>%
        select(-date, -time) %>%
        mutate(datetime = with_tz(datetime, 'UTC')) %>%
        group_by(site_code, datetime, var) %>%
        summarise(val = mean(val, na.rm = TRUE),
                  ms_status = max(ms_status, na.rm = TRUE)) %>%
        ungroup() %>%
        #Temporarily removing alk, the alk in ms_vars is in units of mg/l but
        #here it is reported in eq, not sure how to convert the two
        filter(var != 'alk')

    d <- identify_sampling_bypass(df = d,
                                  is_sensor =  FALSE,
                                  domain = domain,
                                  network = network,
                                  prodname_ms = prodname_ms)

    d <- ms_conversions(d,
                        convert_units_from = c(NH4 = 'umol/l',
                                               CO2 = 'umol/l',
                                               Ca = 'umol/l',
                                               Mg = 'umol/l',
                                               K = 'umol/l',
                                               Na = 'umol/l',
                                               Cl = 'umol/l',
                                               DIC = 'umol/l',
                                               DOC = 'umol/l',
                                               NO3_NO2 = 'umol/l',
                                               CHL = 'ug/l',
                                               TPC = 'ug/l',
                                               TPN = 'ug/l',
                                               TPP = 'ug/l',
                                               phaeopig = 'ug/l',
                                               SiO2 = 'umol/l',
                                               SRP = 'umol/l',
                                               SO4 = 'umol/l',
                                               TDN = 'umol/l',
                                               TDP = 'umol/l',
                                               Al = 'umol/l',
                                               B = 'umol/l',
                                               Cd = 'umol/l',
                                               Cr = 'umol/l',
                                               Cu = 'umol/l',
                                               Fe = 'umol/l',
                                               Pb = 'umol/l',
                                               Mn = 'umol/l',
                                               Ni = 'umol/l',
                                               Si = 'umol/l',
                                               Sr = 'umol/l',
                                               S = 'umol/l',
                                               Zn = 'umol/l',
                                               pheophy = 'ug/l',
                                               TCHL = 'ug/l',
                                               BPC = 'ug/cm2',
                                               BPN = 'ug/cm2',
                                               BPP = 'ug/cm2',
                                               ECHL_A = 'ug/cm2',
                                               E_pheophy = 'ug/cm2',
                                               T_ECHL = 'ug/cm2',
                                               CH4 = 'umol/l'),
                        convert_units_to = c(NH4 = 'mg/l',
                                             CO2 = 'mg/l',
                                             Ca = 'mg/l',
                                             Mg = 'mg/l',
                                             K = 'mg/l',
                                             Na = 'mg/l',
                                             Cl = 'mg/l',
                                             DIC = 'mg/l',
                                             DOC = 'mg/l',
                                             NO3_NO2 = 'mg/l',
                                             CHL = 'mg/l',
                                             TPC = 'mg/l',
                                             TPN = 'mg/l',
                                             TPP = 'mg/l',
                                             phaeopig = 'mg/l',
                                             SiO2 = 'mg/l',
                                             SRP = 'mg/l',
                                             SO4 = 'mg/l',
                                             TDN = 'mg/l',
                                             TDP = 'mg/l',
                                             Al = 'mg/l',
                                             B = 'mg/l',
                                             Cd = 'mg/l',
                                             Cr = 'mg/l',
                                             Cu = 'mg/l',
                                             Fe = 'mg/l',
                                             Pb = 'mg/l',
                                             Mn = 'mg/l',
                                             Ni = 'mg/l',
                                             Si = 'mg/l',
                                             Sr = 'mg/l',
                                             S = 'mg/l',
                                             Zn = 'mg/l',
                                             pheophy = 'mg/l',
                                             TCHL = 'mg/l',
                                             BPC = 'mg/cm2',
                                             BPN = 'mg/cm2',
                                             BPP = 'mg/cm2',
                                             ECHL_A = 'mg/cm2',
                                             E_pheophy = 'mg/cm2',
                                             T_ECHL = 'mg/cm2',
                                             CH4 = 'mg/l'))
    d <- qc_hdetlim_and_uncert(d, prodname_ms = prodname_ms)

    d <- synchronize_timestep(d,
                              desired_interval = '1 day', #set to '15 min' when we have server
                              impute_limit = 30)

    return(d)
}

#precipitation: STATUS=READY
#. handle_errors
process_1_1489 <- function(network, domain, prodname_ms, site_code,
                           component){

    rawfile <- glue('data/{n}/{d}/raw/{p}/{s}/{c}.csv',
                    n = network,
                    d = domain,
                    p = prodname_ms,
                    s = site_code,
                    c = component)

    d <- ms_read_raw_csv(filepath = rawfile,
                         datetime_cols = list('Date' = '%Y%m%d'),
                         datetime_tz = 'America/Anchorage',
                         site_code_col = 'Station',
                         data_cols = c('Daily_Precip_Total_mm' = 'precipitation'),
                         is_sensor = TRUE,
                         set_to_NA = '#N/A',
                         data_col_pattern = '#V#',
                         summary_flagcols = 'Flag_Daily_Precip_Total_mm')

    d <- ms_cast_and_reflag(d,
                            summary_flags_clean = list('Flag_Daily_Precip_Total_mm' = ''),
                            summary_flags_dirty = list('Flag_Daily_Precip_Total_mm' = 'E'),
                            varflag_col_pattern = NA)

    d <- qc_hdetlim_and_uncert(d, prodname_ms = prodname_ms)

    d <- synchronize_timestep(d,
                              desired_interval = '1 day', #set to '15 min' when we have server
                              impute_limit = 30)

    return(d)
}

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_20120 <- function(network, domain, prodname_ms, site_code,
                            component){

    rawfile <- glue('data/{n}/{d}/raw/{p}/{s}/{c}.csv',
                    n = network,
                    d = domain,
                    p = prodname_ms,
                    s = site_code,
                    c = component)

    d <- read.csv(rawfile, colClasses = 'character') %>%
        rename(temp = 7)

    d <- d[4:nrow(d),]

    if(prodname_ms == 'discharge__20120'){

        d <- ms_read_raw_csv(preprocessed_tibble = d,
                             datetime_cols = list('Date' = '%Y-%m-%d',
                                                  'Time' = '%H:%M'),
                             datetime_tz = 'America/Anchorage',
                             site_code_col = 'River',
                             data_cols = c('Discharge..m3.sec.' = 'discharge'),
                             is_sensor = TRUE,
                             alt_site_code = list('Roche_Moutonnee_Creek_Main' = 'Roche Moutonnee Creek',
                                                  'Trevor_Creek_Main' = 'Trevor Creek'),
                             set_to_NA = c('-9999', '-1111'),
                             data_col_pattern = '#V#',
                             summary_flagcols = 'Comments')

        d <- ms_cast_and_reflag(d,
                                summary_flags_clean = list('Comments' = ''),
                                summary_flags_dirty = list('Comments' = c('Late season staff gauge',
                                                                          'WINTER')),
                                varflag_col_pattern = NA)

        d <- d %>%
            mutate(val = val*1000)

    } else{

        d <- ms_read_raw_csv(preprocessed_tibble = d,
                             datetime_cols = list('Date' = '%Y-%m-%d',
                                                  'Time' = '%H:%M'),
                             datetime_tz = 'America/Anchorage',
                             site_code_col = 'River',
                             data_cols = 'temp',
                             is_sensor = TRUE,
                             alt_site_code = list('Roche_Moutonnee_Creek_Main' = 'Roche Moutonnee Creek',
                                                  'Trevor_Creek_Main' = 'Trevor Creek'),
                             set_to_NA = c('-9999', '-1111'),
                             data_col_pattern = '#V#',
                             summary_flagcols = 'Comments')

        d <- ms_cast_and_reflag(d,
                                summary_flags_clean = list('Comments' = ''),
                                summary_flags_dirty = list('Comments' = c('Late season staff gauge',
                                                                          'WINTER')),
                                varflag_col_pattern = NA)
    }

    d <- qc_hdetlim_and_uncert(d, prodname_ms = prodname_ms)

    d <- synchronize_timestep(d,
                              desired_interval = '1 day', #set to '15 min' when we have server
                              impute_limit = 30)

    return(d)
}

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1593 <- munge_toolik

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1594 <- munge_toolik

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1595 <- munge_toolik

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1596 <- munge_toolik

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1597 <- munge_toolik

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1598 <- munge_toolik

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1599 <- munge_toolik

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1600 <- munge_toolik

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1601 <- munge_toolik

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1589 <- munge_toolik

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1590 <- munge_toolik

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1591 <- munge_toolik

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1592 <- munge_toolik

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1645 <- munge_toolik

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1644 <- munge_toolik_2

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_1646 <- munge_toolik_2

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10069 <- munge_toolik_2

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10068 <- munge_toolik_2

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10070 <- munge_toolik

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_10591 <- function(network, domain, prodname_ms, site_code,
                                            component){

    rawfile <- glue('data/{n}/{d}/raw/{p}/{s}/{c}.csv',
                    n = network,
                    d = domain,
                    p = prodname_ms,
                    s = site_code,
                    c = component)

    d <- read.csv(rawfile, colClasses = 'character') %>%
        mutate(site_code = 'Toolik_Inlet_Main') %>%
        rename(Date_Time = 1)

    d <- d[4:nrow(d),]

    if(grepl('discharge', prodname_ms)){

        d <- ms_read_raw_csv(preprocessed_tibble = d,
                             datetime_cols = list('Date_Time' = '%y-%m-%d %H:%M'),
                             datetime_tz = 'America/Anchorage',
                             site_code_col = 'site_code',
                             data_cols =  c('Q_m3sec' = 'discharge'),
                             data_col_pattern = '#V#',
                             set_to_NA = c('-1111', '-1.111'),
                             is_sensor = TRUE)

        d <- ms_cast_and_reflag(d,
                                varflag_col_pattern = NA,
                                variable_flags_to_drop = NA,
                                variable_flags_clean = NA)

        # Convert from cm/s to liters/s
        d <- d %>%
            mutate(val = val*1000)

    } else{

        d <- ms_read_raw_csv(preprocessed_tibble = d,
                             datetime_cols = list('Date_Time' = '%y-%m-%d %H:%M'),
                             datetime_tz = 'America/Anchorage',
                             site_code_col = 'site_code',
                             data_cols =  c('Water_Temp_C' = 'temp',
                                            'Conductivity_uScm' = 'spCond'),
                             data_col_pattern = '#V#',
                             set_to_NA = c('-1111', '-1.111', '-9999'),
                             is_sensor = TRUE)

        d <- ms_cast_and_reflag(d,
                                varflag_col_pattern = NA,
                                variable_flags_to_drop = NA,
                                variable_flags_clean = NA)
    }

    d <- qc_hdetlim_and_uncert(d, prodname_ms = prodname_ms)

    d <- synchronize_timestep(d,
                              desired_interval = '1 day', #set to '15 min' when we have server
                              impute_limit = 30)

    return(d)
}


#derive kernels ####

