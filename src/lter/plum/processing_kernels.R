source('src/lter/plum/domain_helpers.R')

#retrieval kernels ####

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_109 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_110 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_111 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_112 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_113 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_148 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_149 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_150 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_151 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_171 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_172 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_225 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_226 <- retrieve_plum

#discharge: STATUS=READY
#. handle_errors
process_0_388 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_433 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_437 <- retrieve_plum

#discharge: STATUS=READY
#. handle_errors
process_0_389 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_434 <- retrieve_plum

#discharge: STATUS=READY
#. handle_errors
process_0_391 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_435 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_438 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_436 <- retrieve_plum

#discharge: STATUS=READY
#. handle_errors
process_0_390 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_439 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_509 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_525 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_526 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_510 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_527 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_117 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_118 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_152 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_153 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_154 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_155 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_176 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_177 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_178 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_227 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_228 <- retrieve_plum

#discharge: STATUS=READY
#. handle_errors
process_0_396 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_449 <- retrieve_plum

#discharge: STATUS=READY
#. handle_errors
process_0_397 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_450 <- retrieve_plum

#discharge: STATUS=READY
#. handle_errors
process_0_398 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_485 <- retrieve_plum

#discharge: STATUS=READY
#. handle_errors
process_0_399 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_486 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_515 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_516 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_156 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_157 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_158 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_173 <- retrieve_plum

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_0_174 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_229 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_230 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_392 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_393 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_394 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_395 <- retrieve_plum

#stream_chemistry; discharge: STATUS=READY
#. handle_errors
process_0_114 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_115 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_116 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_487 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_488 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_489 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_490 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_506 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_507 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_508 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_444 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_445 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_446 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_447 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_513 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_514 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_448 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_532 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_533 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_534 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_104 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_106 <- retrieve_plum

#stream_chemistry: STATUS=READY
#. handle_errors
process_0_108 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_68 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_69 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_70 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_140 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_141 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_142 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_143 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_162 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_67 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_179 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_180 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_181 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_239 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_343 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_359 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_385 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_417 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_423 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_496 <- retrieve_plum

#precipitation: STATUS=READY
#. handle_errors
process_0_542 <- retrieve_plum

#ws_boundary: STATUS=READY
#. handle_errors
process_0_VERSIONLESS001 <- download_from_googledrive

#munge kernels ####

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_109 <- munge_plum_combined

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_110 <- munge_plum_combined

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_111 <- munge_plum_combined

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_112 <- munge_plum_combined

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_113 <- munge_plum_combined

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_148 <- munge_plum_combined

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_149 <- munge_plum_combined

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_150 <- munge_plum_combined

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_151 <- munge_plum_temp_q

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_171 <- munge_plum_temp_q

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_172 <- munge_plum_temp_q

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_225 <- munge_plum_temp_q

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_226 <- munge_plum_temp_q

#discharge: STATUS=READY
#. handle_errors
process_1_388 <- munge_plum_temp_q

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_433 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_437 <- munge_plum_temp_do

#discharge: STATUS=READY
#. handle_errors
process_1_389 <- munge_plum_temp_q

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_434 <- munge_plum_temp_cond_cart

#discharge: STATUS=READY
#. handle_errors
process_1_391 <- munge_plum_temp_q

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_435 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_438 <- munge_plum_temp_do

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_436 <- munge_plum_temp_cond_cart

#discharge: STATUS=READY
#. handle_errors
process_1_390 <- munge_plum_temp_q

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_439 <- munge_plum_temp_do

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_509 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_525 <- munge_plum_temp_do

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_526 <- munge_plum_temp_do

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_510 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_527 <- munge_plum_temp_do

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_117 <- munge_plum_combined

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_118 <- munge_plum_combined

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_152 <- munge_plum_combined

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_153 <- munge_plum_combined

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_154 <- munge_plum_combined

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_155 <- function(network, domain, prodname_ms, site_code,
                          component){

    rawfile = glue('data/{n}/{d}/raw/{p}/{s}/{c}',
                   n = network,
                   d = domain,
                   p = prodname_ms,
                   s = site_code,
                   c = component)

    code <- prodcode_from_prodname_ms(prodname_ms)

    site <- case_when(code %in% fish_brook ~ 'fish_brook',
                      code %in% cart_creek ~ 'cart_creek',
                      code %in% saw_mill_brook ~ 'saw_mill_brook',
                      code %in% bear_meadow ~ 'bear_meadow')

    d <- read.csv(rawfile, colClasses = 'character') %>%
        mutate(site_code = !!site)

    if(grepl('stream_chemistry', prodname_ms)) {

        d <- ms_read_raw_csv(preprocessed_tibble = d,
                             datetime_cols = list('Date' = '%Y-%m-%d',
                                                  'Time' = '%H:%M'),
                             datetime_tz = 'US/Eastern',
                             site_code_col = 'site_code',
                             data_cols =  c('Temp' = 'temp',
                                            'SpCond' = 'spCond'),
                             data_col_pattern = '#V#',
                             is_sensor = TRUE,
                             sampling_type = 'I')

        d <- ms_cast_and_reflag(d,
                                varflag_col_pattern = NA)

        d <- ms_conversions(d,
                            convert_units_from = c('spCond' = 'mS/cm'),
                            convert_units_to = c('spCond' = 'uS/cm'))

    } else {

        if('Flow' %in% names(d)) {

            d <- d %>%
                rename(Discharge = Flow)
        }

        d <- ms_read_raw_csv(preprocessed_tibble = d,
                             datetime_cols = list('Date' = '%Y-%m-%d',
                                                  'Time' = '%H:%M'),
                             datetime_tz = 'US/Eastern',
                             site_code_col = 'site_code',
                             data_cols =  c('Discharge' = 'discharge'),
                             data_col_pattern = '#V#',
                             is_sensor = TRUE,
                             sampling_type = 'I')

        d <- ms_cast_and_reflag(d,
                                varflag_col_pattern = NA)

    }

     #d <- carry_uncertainty(d,
     #                       network = network,
     #                       domain = domain,
     #                       prodname_ms = prodname_ms)

    # d <- synchronize_timestep(d)
    #
    # d <- apply_detection_limit_t(d, network, domain, prodname_ms)

    return(d)
}

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_176 <- munge_plum_temp_q

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_177 <- munge_plum_temp_q

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_178 <- munge_plum_temp_q

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_227 <- munge_plum_temp_q

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_228 <- munge_plum_temp_q

#discharge: STATUS=READY
#. handle_errors
process_1_396 <- munge_plum_temp_q

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_449 <- munge_plum_temp_cond_cart

#discharge: STATUS=READY
#. handle_errors
process_1_397 <- munge_plum_temp_q

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_450 <- munge_plum_temp_cond_cart

#discharge: STATUS=READY
#. handle_errors
process_1_398 <- munge_plum_temp_q

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_485 <- munge_plum_temp_cond_cart

#discharge: STATUS=READY
#. handle_errors
process_1_399 <- munge_plum_temp_q

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_486 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_515 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_516 <- munge_plum_temp_cond_cart

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_156 <- munge_plum_combined

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_157 <- munge_plum_combined

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_158 <- munge_plum_temp_q

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_173 <- munge_plum_temp_q

#discharge; stream_chemistry: STATUS=READY
#. handle_errors
process_1_174 <- munge_plum_temp_q

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_229 <- munge_plum_temp_q

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_230 <- munge_plum_temp_q

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_392 <- munge_plum_temp_q

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_393 <-  function(network, domain, prodname_ms, site_code,
                           component){

    rawfile = glue('data/{n}/{d}/raw/{p}/{s}/{c}',
                   n = network,
                   d = domain,
                   p = prodname_ms,
                   s = site_code,
                   c = component)

    code <- prodcode_from_prodname_ms(prodname_ms)

    site <- case_when(code %in% fish_brook ~ 'fish_brook',
                      code %in% cart_creek ~ 'cart_creek',
                      code %in% saw_mill_brook ~ 'saw_mill_brook',
                      code %in% bear_meadow ~ 'bear_meadow')

    d <- read.csv(rawfile, colClasses = 'character') %>%
        mutate(site_code = !!site)

    d <- ms_read_raw_csv(preprocessed_tibble = d,
                         datetime_cols = list('Date' = '%m/%e/%Y',
                                              'Time' = '%H:%M'),
                         datetime_tz = 'US/Eastern',
                         site_code_col = 'site_code',
                         data_cols =  c('Temp' = 'temp'),
                         data_col_pattern = '#V#',
                         is_sensor = TRUE,
                         sampling_type = 'I')

    d <- ms_cast_and_reflag(d,
                            varflag_col_pattern = NA)


    # d <- synchronize_timestep(d)
    #
    # d <- apply_detection_limit_t(d, network, domain, prodname_ms)

    return(d)
}

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_394 <- munge_plum_temp_q

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_395 <- munge_plum_temp_q

#stream_chemistry; discharge: STATUS=READY
#. handle_errors
process_1_114 <- munge_plum_combined

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_115 <- munge_plum_combined

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_116 <- munge_plum_combined

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_487 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_488 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_489 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_490 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_506 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_507 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_508 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_444 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_445 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_446 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_447 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_513 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_514 <- munge_plum_temp_cond_cart

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_448 <- munge_plum_temp_do

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_532 <- munge_plum_temp_do

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_533 <- munge_plum_temp_do

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_534 <- munge_plum_temp_do

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_104 <- function(network, domain, prodname_ms, site_code,
                          component) {

    rawfile = glue('data/{n}/{d}/raw/{p}/{s}/{c}',
                   n = network,
                   d = domain,
                   p = prodname_ms,
                   s = site_code,
                   c = component)

    d <- ms_read_raw_csv(filepath = rawfile,
                         datetime_cols = list('DATE' = '%Y-%m-%d',
                                              'TIME' = '%H:%M'),
                         datetime_tz = 'US/Eastern',
                         site_code_col = 'STATION',
                         alt_site_code = list('muddy_run' = 'WAT-RO-MuddyRun',
                                              'little_river' = 'WAT-PR-LittleRiver',
                                              'mill_river' = 'WAT-MI-MillRiver',
                                              'ipswich_dam' = c('WAT-IP-IpswichDam',
                                                                'WAT-IP-Ipswich Dam'),
                                              'parker_dam' = c('WAT-PR-ParkerDam',
                                                               'WAT-PR-Parker Dam'),
                                              'egypt_river' = c('WAT-RO-EgyptRiver',
                                                                'WAT-RO-Egypt River')),
                         data_cols =  c('SAL' = 'salinity',
                                        'NH4' = 'NH4_N',
                                        'NO3' = 'NO3_N',
                                        'PO4' = 'PO4_P',
                                        'TDN', 'DON', 'TDP', 'DOP', 'DOC',
                                        'SS' = 'TSS',
                                        'PP' = 'TPP',
                                        'TEMP' = 'temp',
                                        'POC', 'PON',
                                        'CHLA' = 'CHL'),
                         data_col_pattern = '#V#',
                         set_to_NA = c('NA ', ' '),
                         summary_flagcols = 'COMMENTS',
                         is_sensor = FALSE)

    d <- ms_cast_and_reflag(d,
                            summary_flags_dirty = list('COMMENTS' = '1'),
                            summary_flags_to_drop = list('COMMENTS' = 'DROP'),
                            varflag_col_pattern = NA)

    d <- ms_conversions(d,
                        convert_units_from = c('NH4_N' = 'umol/l',
                                               'NO3_N' = 'umol/l',
                                               'PO4_P' = 'umol/l',
                                               'TDN' = 'umol/l',
                                               'DON' = 'umol/l',
                                               'TDP' = 'umol/l',
                                               'DOP' = 'umol/l',
                                               'DOC' = 'umol/l',
                                               'TPP' = 'umol/l',
                                               'POC' = 'umol/l',
                                               'PON' = 'umol/l'),
                        convert_units_to = c('NH4_N' = 'mg/l',
                                             'NO3_N' = 'mg/l',
                                             'PO4_P' = 'mg/l',
                                             'TDN' = 'mg/l',
                                             'DON' = 'mg/l',
                                             'TDP' = 'mg/l',
                                             'DOP' = 'mg/l',
                                             'DOC' = 'mg/l',
                                             'TPP' = 'mg/l',
                                             'POC' = 'mg/l',
                                             'PON' = 'mg/l'))

    return(d)
}

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_108 <- function(network, domain, prodname_ms, site_code,
                          component) {

    rawfile = glue('data/{n}/{d}/raw/{p}/{s}/{c}',
                   n = network,
                   d = domain,
                   p = prodname_ms,
                   s = site_code,
                   c = component)

    d <- ms_read_raw_csv(filepath = rawfile,
                         datetime_cols = list('Date' = '%Y-%m-%d'),
                         datetime_tz = 'US/Eastern',
                         site_code_col = 'Permanent_ID',
                         alt_site_code = list('cart_creek' = 'YSI-CC',
                                              'bear_meadow' = 'YSI-CS',
                                              'saw_mill_brook' = 'YSI-SB',
                                              'ipswich_dam' = 'IP24',
                                              'parker_dam' = '10',
                                              'fish_brook' = 'YSI-FB',
                                              'upper_ipswich' = 'YSI-IR'),
                         data_cols =  c('NH4' = 'NH4_N',
                                        'PO4' = 'PO4_P',
                                        'NO3' = 'NO3_NO2_N',
                                        'NO2' = 'NO2_N',
                                        'Si', 'Cl', 'SO4', 'Br', 'TDN', 'DON',
                                        'DOC', 'PON', 'POC', 'TSS', 'TDP'),
                         data_col_pattern = '#V#',
                         is_sensor = FALSE)

    d <- ms_cast_and_reflag(d,
                            varflag_col_pattern = NA)

    d <- ms_conversions(d,
                        convert_units_from = c('NH4_N' = 'umol/l',
                                               'PO4_P' = 'umol/l',
                                               'NO3_NO2_N' = 'umol/l',
                                               'NO2_N' = 'umol/l',
                                               'Si' = 'umol/l',
                                               'Cl' = 'umol/l',
                                               'SO4' = 'umol/l',
                                               'Br' = 'umol/l',
                                               'TDN' = 'umol/l',
                                               'DON' = 'umol/l',
                                               'DOC' = 'umol/l',
                                               'PON' = 'umol/l',
                                               'POC' = 'umol/l',
                                               'TDP' = 'umol/l'),
                        convert_units_to = c('NH4_N' = 'mg/l',
                                             'PO4_P' = 'mg/l',
                                             'NO3_NO2_N' = 'mg/l',
                                             'NO2_N' = 'mg/l',
                                             'Si' = 'mg/l',
                                             'Cl' = 'mg/l',
                                             'SO4' = 'mg/l',
                                             'Br' = 'mg/l',
                                             'TDN' = 'mg/l',
                                             'DON' = 'mg/l',
                                             'DOC' = 'mg/l',
                                             'PON' = 'mg/l',
                                             'POC' = 'mg/l',
                                             'TDP' = 'mg/l'))

    return(d)
}

#stream_chemistry: STATUS=READY
#. handle_errors
process_1_106 <- function(network, domain, prodname_ms, site_code,
                          component) {

    rawfile = glue('data/{n}/{d}/raw/{p}/{s}/{c}',
                   n = network,
                   d = domain,
                   p = prodname_ms,
                   s = site_code,
                   c = component)

    d <- read.csv(rawfile, colClasses = 'character') %>%
        filter(SampleType %in% c('Daily', 'TwoDayComposite', 'Volunteer', 
                                 'Composite-timeweighted_6hours'))
    
    # Notes column contains infomation specific to varibles, creatng 
    # variable flags from Notes column 
    d <- d %>%
        mutate(NO3_flag = ifelse(grepl('9', Notes), 1, 0))

    d <- ms_read_raw_csv(preprocessed_tibble = d,
                         datetime_cols = list('Date.1' = '%Y-%m-%d'),
                         datetime_tz = 'US/Eastern',
                         site_code_col = 'Site',
                         alt_site_code = list('cart_creek' = 'CC',
                                              'bear_meadow' = c('CS', 'CS '),
                                              'saw_mill_brook' = 'SB',
                                              'ipswich_dam' = c('ID', 'ID '),
                                              'parker_dam' = 'PD'),
                         data_cols =  c('TP', 'TN', 'NO3' = 'NO3_NO2_N', 'TOC'),
                         summary_flagcols = 'Notes',
                         var_flagcol_pattern = '#V#_flag',
                         data_col_pattern = '#V#',
                         is_sensor = FALSE)

    dirty_summary_flags <- c('Rinse Error ', 'ants (no good?) ', 'replaced distributor-found rain gauge clogged ',
                             '5', '6 9', '6', 'Samples contaminated ', 'Rinse Error 9',
                             '2 samples/bottle? 9', 'LARGE BEETLE ', 'TP and TN are high but consistent with the MBL working file - CTW 2/15/21 ')
    d <- ms_cast_and_reflag(d,
                            summary_flags_dirty = list('Notes' = dirty_summary_flags),
                            summary_flags_to_drop = list('Notes' = 'DROP'),
                            variable_flags_to_drop = 'DROP',
                            variable_flags_dirty = '1')

    d <- ms_conversions(d,
                   convert_units_from = c('TP' = 'umol/l',
                                          'TN' = 'umol/l',
                                          'NO3_NO2_N' = 'umol/l',
                                          'TOC' = 'umol/l'),
                   convert_units_to = c('TP' = 'mg/l',
                                        'TN' = 'mg/l',
                                        'NO3_NO2_N' = 'mg/l',
                                        'TOC' = 'mg/l'))

    return(d)
}

#precipitation: STATUS=READY
#. handle_errors
process_1_68 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_69 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_70 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_140 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_141 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_142 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_143 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_162 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_67 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_179 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_180 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_181 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_239 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_343 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_359 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_385 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_417 <- munge_precip

#precipitation: STATUS=READY
#. handle_errors
process_1_423 <- munge_precip_alt

#precipitation: STATUS=READY
#. handle_errors
process_1_496 <- munge_precip_alt

#precipitation: STATUS=READY
#. handle_errors
process_1_542 <- munge_precip_alt

#ws_boundary: STATUS=READY
#. handle_errors
process_1_VERSIONLESS001 <- function(network, domain, prodname_ms, site_code, component) {

    rawfile <- glue('data/{n}/{d}/raw/ws_boundary__VERSIONLESS001/sitecode_NA/cart_creek.zip',
                    n = network,
                    d = domain)

    mungedir <- glue('data/{n}/{d}/munged/ws_boundary__VERSIONLESS001',
                     n = network,
                     d = domain)

    unzip(rawfile,
          exdir = mungedir)

    sf::st_read(dsn = file.path(mungedir, 'cart_creek')) %>%
        sf::st_transform(4326) %>%
        rename(site_code = site_name) %>%
        sf::st_write(dsn = file.path(mungedir, 'cart_creek'),
                     driver = 'ESRI shapefile',
                     delete_dsn = TRUE)

    return()
}

#derive kernels ####

#precip_gauge_locations: STATUS=READY
#. handle_errors
process_2_ms004 <- precip_gauge_from_site_data

#stream_gauge_locations: STATUS=READY
#. handle_errors
process_2_ms006 <- stream_gauge_from_site_data

#discharge: STATUS=READY
#. handle_errors
process_2_ms001 <- function(network, domain, prodname_ms) {

    files <- ms_list_files(network = network,
                           domain = domain,
                           prodname_ms = c('discharge__111', 'discharge__113',
                                           'discharge__148', 'discharge__149',
                                           'discharge__150', 'discharge__151',
                                           'discharge__171', 'discharge__172',
                                           'discharge__225', 'discharge__226',
                                           'discharge__388', 'discharge__389',
                                           'discharge__391', 'discharge__390',
                                           'discharge__117', 'discharge__118',
                                           'discharge__152', 'discharge__158',
                                           'discharge__154', 'discharge__155',
                                           'discharge__176', 'discharge__177',
                                           'discharge__178', 'discharge__227',
                                           'discharge__228', 'discharge__396',
                                           'discharge__397', 'discharge__398',
                                           'discharge__399', 'discharge__156',
                                           'discharge__157', 'discharge__158',
                                           'discharge__173', 'discharge__174',
                                           'discharge__114'))

    site_feather <- str_split_fixed(files, '/', n = Inf)[,6]
    sites <- unique(str_split_fixed(site_feather, '[.]', n = Inf)[,1])

    d <- tibble()
    for(i in 1:length(sites)) {
        site_files <- grep(sites[i], files, value = TRUE)

        site_full <- map_dfr(site_files, read_feather)

        d <- rbind(d, site_full)
    }

    d <- carry_uncertainty(d,
                           network = network,
                           domain = domain,
                           prodname_ms = prodname_ms)

    d <- synchronize_timestep(d)

    d <- apply_detection_limit_t(X = d,
                                 network = network,
                                 domain = domain,
                                 prodname_ms = prodname_ms,
                                 ignore_pred = TRUE)

    dir <- glue('data/{n}/{d}/derived/{p}',
                n = network,
                d = domain,
                p = prodname_ms)

    dir.create(dir, showWarnings = FALSE)

    for(i in 1:length(sites)) {

        site_full <- filter(d, site_code == !!sites[i])

        write_ms_file(d = site_full,
                      network = network,
                      domain = domain,
                      prodname_ms = prodname_ms,
                      site_code = sites[i],
                      level = 'derived',
                      shapefile = FALSE)
    }

    return()
}

#stream_chemistry: STATUS=READY
#. handle_errors
process_2_ms002 <- function(network, domain, prodname_ms) {

    files <- ms_list_files(network = network,
                           domain = domain,
                           prodname_ms = c('stream_chemistry__109', 'stream_chemistry__110',
                                           'stream_chemistry__111', 'stream_chemistry__112',
                                           'stream_chemistry__113', 'stream_chemistry__148',
                                           'stream_chemistry__149', 'stream_chemistry__150',
                                           'stream_chemistry__151', 'stream_chemistry__171',
                                           'stream_chemistry__172', 'stream_chemistry__225',
                                           'stream_chemistry__226', 'stream_chemistry__433',
                                           'stream_chemistry__437', 'stream_chemistry__434',
                                           'stream_chemistry__435', 'stream_chemistry__438',
                                           'stream_chemistry__436', 'stream_chemistry__439',
                                           'stream_chemistry__509', 'stream_chemistry__525',
                                           'stream_chemistry__526', 'stream_chemistry__510',
                                           'stream_chemistry__527', 'stream_chemistry__117',
                                           'stream_chemistry__118', 'stream_chemistry__152',
                                           'stream_chemistry__153', 'stream_chemistry__154',
                                           'stream_chemistry__155', 'stream_chemistry__176',
                                           'stream_chemistry__177', 'stream_chemistry__178',
                                           'stream_chemistry__227', 'stream_chemistry__228',
                                           'stream_chemistry__449', 'stream_chemistry__450',
                                           'stream_chemistry__485', 'stream_chemistry__486',
                                           'stream_chemistry__515', 'stream_chemistry__516',
                                           'stream_chemistry__156', 'stream_chemistry__157',
                                           'stream_chemistry__158', 'stream_chemistry__173',
                                           'stream_chemistry__174', 'stream_chemistry__229',
                                           'stream_chemistry__230', 'stream_chemistry__392',
                                           'stream_chemistry__393', 'stream_chemistry__394',
                                           'stream_chemistry__395', 'stream_chemistry__114',
                                           'stream_chemistry__115', 'stream_chemistry__116',
                                           'stream_chemistry__487', 'stream_chemistry__488',
                                           'stream_chemistry__489', 'stream_chemistry__490',
                                           'stream_chemistry__506', 'stream_chemistry__507',
                                           'stream_chemistry__508', 'stream_chemistry__444',
                                           'stream_chemistry__445', 'stream_chemistry__446',
                                           'stream_chemistry__447', 'stream_chemistry__513',
                                           'stream_chemistry__514', 'stream_chemistry__448',
                                           'stream_chemistry__532', 'stream_chemistry__533',
                                           'stream_chemistry__534', 'stream_chemistry__104',
                                           'stream_chemistry__108', 'stream_chemistry__106'))

    site_feather <- str_split_fixed(files, '/', n = Inf)[,6]
    sites <- unique(str_split_fixed(site_feather, '[.]', n = Inf)[,1])

    d <- tibble()
    for(i in 1:length(sites)) {
        site_files <- grep(sites[i], files, value = TRUE)

        site_full <- map_dfr(site_files, read_feather)

        d <- rbind(d, site_full)
    }

    d <- carry_uncertainty(d,
                           network = network,
                           domain = domain,
                           prodname_ms = prodname_ms)

    d <- synchronize_timestep(d)

    d <- apply_detection_limit_t(d, network, domain, prodname_ms, ignore_pred = TRUE)

    dir <- glue('data/{n}/{d}/derived/{p}',
                n = network,
                d = domain,
                p = prodname_ms)

    dir.create(dir, showWarnings = FALSE)

    for(i in 1:length(sites)) {

        site_full <- filter(d, site_code == !!sites[i])

        write_ms_file(d = site_full,
                      network = network,
                      domain = domain,
                      prodname_ms = prodname_ms,
                      site_code = sites[i],
                      level = 'derived',
                      shapefile = FALSE)
    }

    return()
}

#precipitation: STATUS=READY
#. handle_errors
process_2_ms003 <- function(network, domain, prodname_ms){

    precip_prodname_ms <- get_derive_ingredient(network = network,
                                                domain = domain,
                                                prodname = 'precipitation',
                                                ignore_derprod = TRUE,
                                                accept_multiple = TRUE)

    files <- ms_list_files(network = network,
                           domain = domain,
                           prodname_ms = precip_prodname_ms)

    site_feather <- str_split_fixed(files, '/', n = Inf)[,6]
    sites <- unique(str_split_fixed(site_feather, '[.]', n = Inf)[,1])

    d <- tibble()
    for(i in 1:length(sites)) {
        site_files <- grep(sites[i], files, value = TRUE)

        site_full <- map_dfr(site_files, read_feather)

        d <- rbind(d, site_full)
    }

    d <- carry_uncertainty(d,
                           network = network,
                           domain = domain,
                           prodname_ms = prodname_ms)

    d <- synchronize_timestep(d)

    d <- apply_detection_limit_t(d, network, domain, prodname_ms, ignore_pred = TRUE)

    dir <- glue('data/{n}/{d}/derived/{p}',
                n = network,
                d = domain,
                p = prodname_ms)

    dir.create(dir, showWarnings = FALSE)

    for(i in 1:length(sites)) {

        site_full <- filter(d, site_code == !!sites[i])

        write_ms_file(d = site_full,
                      network = network,
                      domain = domain,
                      prodname_ms = prodname_ms,
                      site_code = sites[i],
                      level = 'derived',
                      shapefile = FALSE)
    }

    return()
}

#precipitation: STATUS=OBSOLETE
#. handle_errors
process_2_ms007 <- function(network, domain, prodname_ms){

    wb_prodname_ms <- get_derive_ingredient(network = network,
                                            domain = domain,
                                            prodname = 'ws_boundary',
                                            accept_multiple = TRUE)

    rg_prodname_ms <- get_derive_ingredient(network = network,
                                            domain = domain,
                                            prodname = 'precip_gauge_locations',
                                            accept_multiple = TRUE)

    precip_idw(precip_prodname = 'precipitation_ns__ms003',
               wb_prodname = wb_prodname_ms,
               pgauge_prodname = rg_prodname_ms,
               precip_prodname_out = prodname_ms)

    return()
}

#stream_flux_inst: STATUS=READY
#. handle_errors
process_2_ms005 <- function(network, domain, prodname_ms){

    schem_prodname_ms <- get_derive_ingredient(network = network,
                                               domain = domain,
                                               prodname = 'stream_chemistry',
                                               accept_multiple = TRUE)

    disch_prodname_ms <- get_derive_ingredient(network = network,
                                               domain = domain,
                                               prodname = 'discharge',
                                               accept_multiple = TRUE)

    chemfiles <- ms_list_files(network = network,
                               domain = domain,
                               prodname_ms = schem_prodname_ms)

    qfiles <- ms_list_files(network = network,
                            domain = domain,
                            prodname_ms = disch_prodname_ms)

    flux_sites <- base::intersect(
        fname_from_fpath(qfiles, include_fext = FALSE),
        fname_from_fpath(chemfiles, include_fext = FALSE))

    for(s in flux_sites){

        flux <- sw(calc_inst_flux(chemprod = schem_prodname_ms,
                                  qprod = disch_prodname_ms,
                                  site_code = s,
                                  ignore_pred = TRUE))

        if(!is.null(flux)) {

            write_ms_file(d = flux,
                          network = network,
                          domain = domain,
                          prodname_ms = prodname_ms,
                          site_code = s,
                          level = 'derived',
                          shapefile = FALSE)
        }
    }

    return()
}

#precip_pchem_pflux: STATUS=READY
#. handle_errors
process_2_ms008 <- derive_precip_pchem_pflux
